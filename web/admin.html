<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Admin panel for MODSN.AI">
  <title>Admin Zone</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="embed.css">
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const user = await loadUserInfo();

      const stats = await fetchJSON('/stats');
      if (stats)
        document.getElementById('stats').textContent = `Bot on ${stats.botGuilds} servers`;

      const guildSelect = document.getElementById('guild');
      const guildGroup = document.getElementById('guildGroup');
      const channelSelect = document.getElementById('channel');
      const form = document.getElementById('msgForm');
      const embedForm = document.getElementById('embedForm');
      const emojiInput = document.getElementById('emojiInput');
      const emojiPicker = document.getElementById('emojiPicker');
      const embedPreview = document.getElementById('embedPreview');
      const embedTitle = document.getElementById('embedTitle');
      const embedDescription = document.getElementById('embedDescription');
      const embedColor = document.getElementById('embedColor');
      const embedUrl = document.getElementById('embedUrl');
      const embedAuthorName = document.getElementById('embedAuthorName');
      const embedAuthorIcon = document.getElementById('embedAuthorIcon');
      const embedFooterText = document.getElementById('embedFooterText');
      const embedFooterIcon = document.getElementById('embedFooterIcon');
      const embedImage = document.getElementById('embedImage');
      const embedThumbnail = document.getElementById('embedThumbnail');
      const embedTimestamp = document.getElementById('embedTimestamp');
      const embedFields = document.getElementById('embedFields');
      const descPreview = document.getElementById('descPreview');
      const params = new URLSearchParams(window.location.search);
      const guildId = params.get('guildId');
      const commandsLink = document.getElementById('commandsLink');
      if (commandsLink) {
        if (guildId) {
          commandsLink.href = `commands.html?guildId=${guildId}`;
        } else {
          commandsLink.style.display = 'none';
        }
      }

      const loadChannels = async (id) => {
        channelSelect.innerHTML = '';
        const channels = await fetchJSON(`/channels/${id}`);
        if (channels)
          channels.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            channelSelect.appendChild(opt);
          });
      };

      if (guildId) {
        guildGroup.style.display = 'none';
        await loadChannels(guildId);
      } else {
        const guilds = await fetchJSON('/guilds');
        if (guilds)
          guilds.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.id;
            opt.textContent = g.name;
            guildSelect.appendChild(opt);
          });
        guildSelect.addEventListener('change', () => loadChannels(guildSelect.value));
        guildSelect.dispatchEvent(new Event('change'));
      }

      const formatButtons = document.querySelectorAll('.formatting-toolbar button');

      function applyFormat(fmt) {
        const start = embedDescription.selectionStart;
        const end = embedDescription.selectionEnd;
        let prefix = fmt;
        let suffix = fmt;
        if (fmt === '```') {
          prefix = '```\n';
          suffix = '\n```';
        }
        const selected = embedDescription.value.slice(start, end);
        embedDescription.setRangeText(prefix + selected + suffix, start, end, 'end');
        embedDescription.focus();
        updatePreview();
      }

      formatButtons.forEach(btn => btn.addEventListener('click', () => applyFormat(btn.dataset.format)));

      emojiInput.addEventListener('click', () => {
        emojiPicker.style.display = 'block';
      });

      emojiPicker.addEventListener('emoji-click', e => {
        emojiInput.value = e.detail.unicode;
        emojiPicker.style.display = 'none';
        updatePreview();
      });

      document.addEventListener('click', e => {
        if (!emojiPicker.contains(e.target) && e.target !== emojiInput) {
          emojiPicker.style.display = 'none';
        }
      });

      function formatDiscord(text) {
        return text
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/__(.*?)__/g, '<u>$1</u>')
          .replace(/~~(.*?)~~/g, '<s>$1</s>')
          .replace(/```([\s\S]+?)```/g, '<pre>$1</pre>')
          .replace(/`([^`]+)`/g, '<code>$1</code>');
      }

      function buildPreviewEmbed() {
        const embed = {
          title: embedTitle.value,
          description: `${emojiInput.value ? emojiInput.value + ' ' : ''}${embedDescription.value}`.trim(),
          color: embedColor.value
        };
        if (embedUrl.value) embed.url = embedUrl.value;
        if (embedTimestamp.checked) embed.timestamp = new Date().toISOString();
        if (embedAuthorName.value || embedAuthorIcon.value) {
          embed.author = {};
          if (embedAuthorName.value) embed.author.name = embedAuthorName.value;
          if (embedAuthorIcon.value) embed.author.icon_url = embedAuthorIcon.value;
        }
        if (embedFooterText.value || embedFooterIcon.value) {
          embed.footer = {};
          if (embedFooterText.value) embed.footer.text = embedFooterText.value;
          if (embedFooterIcon.value) embed.footer.icon_url = embedFooterIcon.value;
        }
        if (embedImage.value) embed.image = { url: embedImage.value };
        if (embedThumbnail.value) embed.thumbnail = { url: embedThumbnail.value };
        if (embedFields.value.trim()) {
          embed.fields = embedFields.value.trim().split('\n').map(line => {
            const [name, value, inline] = line.split('|');
            return { name: name || '', value: value || '', inline: inline === 'inline' };
          });
        }
        return embed;
      }

      function updatePreview() {
        const embed = buildPreviewEmbed();
        descPreview.innerHTML = formatDiscord(embedDescription.value);
        let html = '';
        if (embed.author && embed.author.name) {
          html += '<div class="embed-author">';
          if (embed.author.icon_url) html += `<img src="${embed.author.icon_url}" alt="">`;
          html += `<span>${embed.author.name}</span></div>`;
        }
        if (embed.title) html += `<div class="embed-title">${embed.title}</div>`;
        if (embed.description) html += `<div class="embed-description">${formatDiscord(embed.description)}</div>`;
        if (Array.isArray(embed.fields)) {
          html += '<div class="embed-fields">';
          embed.fields.forEach(f => {
            html += `<div class="embed-field"><strong>${f.name}</strong>: ${formatDiscord(f.value)}</div>`;
          });
          html += '</div>';
        }
        if (embed.footer && embed.footer.text) {
          html += '<div class="embed-footer">';
          if (embed.footer.icon_url) html += `<img src="${embed.footer.icon_url}" alt="">`;
          html += `<span>${embed.footer.text}</span></div>`;
        }
        embedPreview.style.borderLeftColor = embed.color;
        embedPreview.innerHTML = html;
      }

      [
        embedTitle,
        embedDescription,
        embedColor,
        embedUrl,
        embedAuthorName,
        embedAuthorIcon,
        embedFooterText,
        embedFooterIcon,
        embedImage,
        embedThumbnail,
        embedTimestamp,
        embedFields,
        emojiInput
      ].forEach(el => el && el.addEventListener('input', updatePreview));

      updatePreview();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
          channelId: channelSelect.value,
          message: document.getElementById('message').value
        };
        const res = await fetch('/message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        alert(await res.text());
        form.reset();
      });

      if (embedForm) {
        embedForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const embed = {
            title: embedTitle.value,
            description: `${emojiInput.value ? emojiInput.value + ' ' : ''}${embedDescription.value}`.trim(),
            color: parseInt(embedColor.value.replace('#', ''), 16)
          };
          if (embedUrl.value) embed.url = embedUrl.value;
          if (embedTimestamp.checked) embed.timestamp = new Date().toISOString();
          if (embedAuthorName.value || embedAuthorIcon.value) {
            embed.author = {};
            if (embedAuthorName.value) embed.author.name = embedAuthorName.value;
            if (embedAuthorIcon.value) embed.author.icon_url = embedAuthorIcon.value;
          }
          if (embedFooterText.value || embedFooterIcon.value) {
            embed.footer = {};
            if (embedFooterText.value) embed.footer.text = embedFooterText.value;
            if (embedFooterIcon.value) embed.footer.icon_url = embedFooterIcon.value;
          }
          if (embedImage.value) embed.image = { url: embedImage.value };
          if (embedThumbnail.value) embed.thumbnail = { url: embedThumbnail.value };
          if (embedFields.value.trim()) {
            embed.fields = embedFields.value.trim().split('\n').map(line => {
              const [name, value, inline] = line.split('|');
              return { name: name || '', value: value || '', inline: inline === 'inline' };
            });
          }
          const body = {
            channelId: channelSelect.value,
            embed
          };
          const res = await fetch('/embed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          alert(await res.text());
          embedForm.reset();
        });
      }
    });
  </script>
</head>
<body>
  <header class="topbar">
    <h2>MODSN.AI</h2>
    <nav>
      <a href="servers.html" class="link">Servers</a>
    </nav>
  </header>
  <div class="sidebar">
    <div class="user-info">
      <img id="avatar" class="avatar" src="" alt="avatar">
      <div id="username"></div>
      <p id="stats"></p>
    </div>
    <nav>
      <a href="servers.html" class="link">Servers</a>
      <a href="commands.html" id="commandsLink" class="link">Commands</a>
      <a href="/logout" class="link">Logout</a>
    </nav>
  </div>
  <main class="main">
    <div class="card tilt">
      <h1>Admin Zone</h1>
      <form id="msgForm">
        <div class="form-group" id="guildGroup">
          <label>Guild</label>
          <select id="guild"></select>
        </div>
        <div class="form-group">
          <label>Channel</label>
          <select id="channel"></select>
        </div>
        <div class="form-group">
          <label>Message</label>
          <input type="text" id="message" required>
        </div>
        <button class="btn" style="margin-top:1rem;">Send</button>
      </form>
    </div>
    <div class="card tilt" style="margin-top:2rem;">
      <h2>Rich Embed</h2>
      <form id="embedForm">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="embedTitle" maxlength="256" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <div class="formatting-toolbar">
            <button type="button" data-format="**"><b>B</b></button>
            <button type="button" data-format="*"><i>I</i></button>
            <button type="button" data-format="__"><u>U</u></button>
            <button type="button" data-format="~~"><s>S</s></button>
            <button type="button" data-format="`">Code</button>
            <button type="button" data-format="```">Block</button>
          </div>
          <textarea id="embedDescription" required></textarea>
          <div id="descPreview" class="desc-preview"></div>
        </div>
        <div class="form-group">
          <label>Color</label>
          <input type="color" id="embedColor" value="#5865F2">
        </div>
        <div class="form-group">
          <label>URL</label>
          <input type="url" id="embedUrl">
        </div>
        <div class="form-group">
          <label>Author Name</label>
          <input type="text" id="embedAuthorName" maxlength="256">
        </div>
        <div class="form-group">
          <label>Author Icon URL</label>
          <input type="url" id="embedAuthorIcon">
        </div>
        <div class="form-group">
          <label>Footer Text</label>
          <input type="text" id="embedFooterText" maxlength="2048">
        </div>
        <div class="form-group">
          <label>Footer Icon URL</label>
          <input type="url" id="embedFooterIcon">
        </div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="url" id="embedImage">
        </div>
        <div class="form-group">
          <label>Thumbnail URL</label>
          <input type="url" id="embedThumbnail">
        </div>
        <div class="form-group">
          <label><input type="checkbox" id="embedTimestamp"> Add Timestamp</label>
        </div>
        <div class="form-group">
          <label>Fields (name|value|inline per line)</label>
          <textarea id="embedFields"></textarea>
        </div>
        <div class="form-group">
          <label>Emoji Prefix</label>
          <div class="emoji-picker-wrapper">
            <input type="text" id="emojiInput" readonly placeholder="Click to pick">
            <emoji-picker id="emojiPicker"></emoji-picker>
          </div>
        </div>
        <button class="btn" style="margin-top:1rem;">Send Embed</button>
        <div id="embedPreview" class="embed-preview"></div>
      </form>
    </div>
  </main>
  <footer class="footer">Panel MODSN.AI &copy; 2025</footer>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1"></script>
  <script src="script.js"></script>
</body>
</html>
